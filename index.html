<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Patient Registration</title>
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    // --- Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
      .then(function(reg) {
        console.log('Service Worker Registered', reg);
      }).catch(function(err) {
        console.error('Service Worker registration failed: ', err);
      });
    }

    // Save data offline using localStorage.
    function saveOfflineData(data) {
      let unsyncedData = JSON.parse(localStorage.getItem('unsyncedData')) || [];
      unsyncedData.push(data);
      localStorage.setItem('unsyncedData', JSON.stringify(unsyncedData));
      console.log('Data saved offline:', data);
    }

    // Send data to the Google Apps Script endpoint.
    function sendData(data) {
      const scriptURL = 'https://script.google.com/macros/s/AKfycbxOkIcDQvG96JbY9QJ8yqwyXJPB8rUTJ-WnsOqyO77ClPnKPMB5zbNejvYdCnB_hb6GUA/exec'; // Replace with your actual URL
      return fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',  // using no-cors mode for a simple POST
        body: JSON.stringify(data)
      })
      .then(() => {
        console.log('Data sent successfully for:', data);
        return true;
      })
      .catch(error => {
        console.error('Error sending data for:', data, error);
        return false;
      });
    }

    // Asynchronously sync any stored offline data when connectivity is restored.
    async function syncData() {
      let unsyncedData = JSON.parse(localStorage.getItem('unsyncedData')) || [];
      if (unsyncedData.length === 0) {
        return; // Nothing to sync.
      }
      
      // Array to hold records that fail to send.
      let remainingData = [];
      
      // Loop over each unsynced record sequentially.
      for (const data of unsyncedData) {
        const success = await sendData(data);
        if (!success) {
          remainingData.push(data);
        }
      }
      
      // Update localStorage with any records that were not successfully synced.
      localStorage.setItem('unsyncedData', JSON.stringify(remainingData));
      
      if (remainingData.length > 0) {
        console.log('Some records were not synced and remain stored locally.');
      } else {
        console.log('All offline data has been successfully synced.');
      }
    }

    // Handle form submission.
    function submitForm(event) {
      event.preventDefault();
      
      // Gather form values.
      const patientName = document.getElementById('patientName').value;
      const age = document.getElementById('age').value;
      const email = document.getElementById('email').value;
      
      // Build the data object.
      const data = {
        patientName: patientName,
        age: age,
        email: email
      };
      
      // Check connectivity and either send immediately or save offline.
      if (navigator.onLine) {
        sendData(data);
      } else {
        alert("No connectivity; data saved offline.");
        saveOfflineData(data);
      }
      
      // Reset the form.
      document.getElementById('registrationForm').reset();
    }

    // When the page loads, if online, attempt to sync offline data.
    window.addEventListener('load', function() {
      if (navigator.onLine) {
        syncData();
      }
    });
    
    // Listen for the browser regaining online connectivity.
    window.addEventListener('online', syncData);
  </script>
</head>
<body>
  <h1>Patient Registration</h1>
  <form id="registrationForm" onsubmit="submitForm(event)">
    <label for="patientName">Patient Name:</label><br>
    <input type="text" id="patientName" name="patientName" required><br><br>

    <label for="age">Age:</label><br>
    <input type="number" id="age" name="age" required><br><br>

    <label for="email">Email:</label><br>
    <input type="email" id="email" name="email" required><br><br>

    <input type="submit" value="Submit">
  </form>
</body>
</html>
