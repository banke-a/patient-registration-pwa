<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Patient Registration</title>
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script>
    // --- Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
      .then(function(reg) {
        console.log('Service Worker Registered', reg);
      }).catch(function(err) {
        console.error('Service Worker registration failed: ', err);
      });
    }

    // Simple UUID generator
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
      });
    }

    // Save data offline using localStorage.
    function saveOfflineData(data) {
      let unsyncedData = JSON.parse(localStorage.getItem('unsyncedData')) || [];
      unsyncedData.push(data);
      localStorage.setItem('unsyncedData', JSON.stringify(unsyncedData));
      console.log('Data saved offline:', data);
    }

    // Send data to the Google Apps Script endpoint.
    function sendData(data) {
      const scriptURL = 'https://script.google.com/macros/s/AKfycbxH-2H4Ku_W4AmyhoPtLPz0UvJzCENAOdfwZGZLAiEAt9rIj7ac5C38FWPX1_Yy9oXXbw/exec'; // Replace with your actual URL
      return fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',  // using no-cors for a simple POST; note this makes responses opaque.
        body: JSON.stringify(data)
      })
      .then(() => {
        console.log('Data sent successfully for:', data);
        return true;
      })
      .catch(error => {
        console.error('Error sending data for:', data, error);
        return false;
      });
    }

    // Asynchronously sync any stored offline data when connectivity is restored.
    async function syncData() {
      let unsyncedData = JSON.parse(localStorage.getItem('unsyncedData')) || [];
      if (unsyncedData.length === 0) return; // Nothing to sync.
      
      let remainingData = [];
      for (const data of unsyncedData) {
        const success = await sendData(data);
        if (!success) {
          remainingData.push(data);
        }
      }
      
      localStorage.setItem('unsyncedData', JSON.stringify(remainingData));
      if (remainingData.length > 0) {
        console.log('Some records were not synced and remain stored locally.');
      } else {
        console.log('All offline data has been successfully synced.');
      }
    }

    // Handle form submission.
    function submitForm(event) {
      event.preventDefault();

      // Generate a UUID for this registration if not already present.
      let patientUUID = generateUUID();

      // Gather form values.
      const name = document.getElementById('name').value;
      const age = document.getElementById('age').value;
      const email = document.getElementById('email').value;

      // Build the data object.
      const data = {
        patient_id: patientUUID,
        name: name,
        age: age,
        email: email
      };

      // Check connectivity and either send immediately or save offline.
      if (navigator.onLine) {
        sendData(data);
      } else {
        alert("No connectivity; data saved offline.");
        saveOfflineData(data);
      }

      // Optionally, display the generated patient_id to the field agent.
      alert("Patient registered with ID: " + patientUUID);
      
      // Reset the form.
      document.getElementById('registrationForm').reset();
    }

    // When the page loads, if online, attempt to sync offline data.
    window.addEventListener('load', function() {
      if (navigator.onLine) {
        syncData();
      }
    });

    // Listen for the browser regaining online connectivity.
    window.addEventListener('online', syncData);
  </script>
</head>
<body>
  <h1>Patient Registration</h1>
  <form id="registrationForm" onsubmit="submitForm(event)">
    <label for="name">Patient Name:</label><br>
    <input type="text" id="name" name="name" required><br><br>

    <label for="age">Age:</label><br>
    <input type="number" id="age" name="age" required><br><br>

    <label for="email">Email:</label><br>
    <input type="email" id="email" name="email" required><br><br>

    <input type="submit" value="Submit">
  </form>
</body>
</html>
